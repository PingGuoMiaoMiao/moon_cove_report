///|
fn main {
  // è·å–å‘½ä»¤è¡Œå‚æ•°
  let args = @sys.get_cli_args()
  if args.length() < 4 {
    println("Usage: " + args[0] + " <coverage_path> <source_dir> <output_dir>")
    println("Example: moon run main coverage.lcov src/ reports/")
    @sys.exit(1)
  }
  let coverage_path = args[1]
  let source_dir = args[2]
  let output_dir = args[3]
  println("Processing coverage report:")
  println("Coverage file: " + coverage_path)
  println("Source directory: " + source_dir)
  println("Output directory: " + output_dir)

  // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
  match @cove.ensure_output_dir_exists(output_dir) {
    Ok(_) => ignore(Ok(_))
    Err(msg) => {
      println("âŒ Error creating output directory: " + msg)
      @sys.exit(1)
    }
  }

  // è¯»å–è¦†ç›–ç‡æ–‡ä»¶
  let mut coverage_data = @cove.CoverageData::{
    files: Map::new(),
    total_points: 0,
    covered_points: 0,
  }
  match @cove.read_coverage_file(coverage_path) {
    Err(msg) => {
      println("âŒ Error reading coverage file: " + msg)
      @sys.exit(1)
    }
    Ok(data) => {
      println(
        "âœ… Successfully read coverage data for " +
        data.files.size().to_string() +
        " files",
      )
      coverage_data = data
    }
  }

  // åŠ è½½æºä»£ç æ–‡ä»¶ - ä½¿ç”¨æ”¹è¿›çš„å‡½æ•°
  println("ğŸ”„ åŠ è½½æºä»£ç æ–‡ä»¶...")
  let source_files = @cove.load_source_files(coverage_data, source_dir)
  println("âœ… åŠ è½½ " + source_files.size().to_string() + " ä¸ªæºæ–‡ä»¶")

  // å¦‚æœåŠ è½½çš„æºæ–‡ä»¶æ•°é‡å°‘äºè¦†ç›–ç‡æ–‡ä»¶æ•°é‡ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•
  if source_files.size() < coverage_data.files.size() {
    println("âš ï¸ è­¦å‘Š: éƒ¨åˆ†æºæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•...")

    // å°è¯•ä½¿ç”¨ç›¸å¯¹è·¯å¾„
    let relative_source_dir = "src" // æˆ–è€…ä»è¦†ç›–ç‡æ•°æ®ä¸­æ¨æ–­
    let alt_source_files = @cove.load_source_files(
      coverage_data, relative_source_dir,
    )

    // åˆå¹¶æ‰¾åˆ°çš„æºæ–‡ä»¶
    alt_source_files.each(fn(filename : String, content : String) {
      if !source_files.contains(filename) {
        source_files.set(filename, content)
        println("âœ… å¤‡ç”¨æ–¹æ³•æ‰¾åˆ°æ–‡ä»¶: " + filename)
      }
    })
    println(
      "ğŸ”„ æœ€ç»ˆåŠ è½½ " + source_files.size().to_string() + " ä¸ªæºæ–‡ä»¶",
    )
  }

  // ç”Ÿæˆè¡Œè§†å›¾
  let views = @cove.map_to_line_view(coverage_data, source_files)
  println(
    "âœ… Created coverage views for " + views.length().to_string() + " files",
  )

  // è®¡ç®—æ€»ä½“è¦†ç›–ç‡
  let overall_coverage = @cove.get_overall_coverage(coverage_data)
  println("ğŸ“Š Overall coverage: " + overall_coverage.to_string() + "%")

  // ç”Ÿæˆä¸»HTMLæŠ¥å‘Š
  let main_report_html = @cove.generate_main_report(views, coverage_data)
  println("ğŸ–¥ï¸ Generated main HTML report")

  // ä¿å­˜ä¸»æŠ¥å‘Š
  let main_report_path = @cove.join_path(output_dir, "index.html")
  match @cove.save_report(main_report_html, main_report_path) {
    Err(msg) => {
      println("âŒ Error saving main report: " + msg)
      @sys.exit(1)
    }
    Ok(_) =>
      println("âœ… Main report successfully saved to: " + main_report_path)
  }

  // ä¸ºæ¯ä¸ªæ–‡ä»¶ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
  let mut current_view = views
  while current_view.length() > 0 {
    match current_view.head() {
      Some(view) => {
        let detail_report_html = @cove.generate_file_detail_report(
          view, coverage_data,
        )

        // ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
        let safe_filename = @cove.generate_safe_filename(view.filename)
        let detail_report_path = @cove.join_path(output_dir, safe_filename)
        match @cove.save_report(detail_report_html, detail_report_path) {
          Err(msg) =>
            println(
              "âŒ Error saving detail report for " + view.filename + ": " + msg,
            )
          Ok(_) =>
            println(
              "âœ… Detail report successfully saved to: " + detail_report_path,
            )
        }
        current_view = current_view.tail()
      }
      None => break
    }
  }
  println("ğŸ‰ Coverage report generation complete!")
  @sys.exit(0)
}
